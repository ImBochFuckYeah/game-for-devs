<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{admin-layout :: layout(~{::title}, ~{::main})}">
<head>
    <title>Estadísticas del Sistema - Game For Devs Admin</title>
</head>
<body>
    <main>
        <div class="container-fluid px-4">
            <h1 class="mt-4">
                <i class="fas fa-chart-bar text-primary me-2"></i>Estadísticas del Sistema
            </h1>
            <ol class="breadcrumb mb-4">
                <li class="breadcrumb-item"><a href="/admin">Dashboard</a></li>
                <li class="breadcrumb-item active">Estadísticas</li>
            </ol>
            
            <!-- Controles de actualización y periodo -->
            <div class="mb-4 d-flex justify-content-between align-items-center">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary btn-sm active" data-period="7">Últimos 7 días</button>
                    <button type="button" class="btn btn-outline-primary btn-sm" data-period="30">30 días</button>
                    <button type="button" class="btn btn-outline-primary btn-sm" data-period="90">90 días</button>
                </div>
                <div>
                    <button type="button" class="btn btn-info btn-sm" onclick="refreshStatistics()">
                        <i class="fas fa-sync me-1"></i>Actualizar
                    </button>
                    <button type="button" class="btn btn-success btn-sm" onclick="exportStatistics()">
                        <i class="fas fa-download me-1"></i>Exportar
                    </button>
                </div>
            </div>
            
            <!-- Métricas principales -->
            <div class="row mb-4">
                <div class="col-lg-3 col-md-6">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <div class="small text-uppercase">Partidas Totales</div>
                                    <div class="h3" id="totalGames">--</div>
                                </div>
                                <div class="ms-3">
                                    <i class="fas fa-gamepad fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <div class="small text-uppercase">Completadas</div>
                                    <div class="h3" id="completedGames">--</div>
                                </div>
                                <div class="ms-3">
                                    <i class="fas fa-check-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="card bg-warning text-dark">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <div class="small text-uppercase">Tiempo Promedio</div>
                                    <div class="h3" id="averageTime">--</div>
                                </div>
                                <div class="ms-3">
                                    <i class="fas fa-clock fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <div class="small text-uppercase">Usuarios Activos</div>
                                    <div class="h3" id="activeUsers">--</div>
                                </div>
                                <div class="ms-3">
                                    <i class="fas fa-users fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Gráficos principales -->
            <div class="row mb-4">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-line me-1"></i>Actividad Diaria
                        </div>
                        <div class="card-body">
                            <div id="dailyActivityChart" style="height: 300px;">
                                <div class="d-flex justify-content-center align-items-center h-100">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-pie me-1"></i>Estado de Partidas
                        </div>
                        <div class="card-body">
                            <div id="gameStatusChart" style="height: 300px;">
                                <div class="d-flex justify-content-center align-items-center h-100">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Estadísticas detalladas -->
            <div class="row">
                <div class="col-lg-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="fas fa-map me-1"></i>Rendimiento por Pista
                        </div>
                        <div class="card-body">
                            <div id="loadingTracks" class="text-center py-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                            </div>
                            <div class="table-responsive" id="trackStatsTable" style="display: none;">
                                <table class="table table-hover table-sm">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Pista</th>
                                            <th>Partidas</th>
                                            <th>Éxito</th>
                                            <th>Tiempo Prom.</th>
                                        </tr>
                                    </thead>
                                    <tbody id="trackStatsBody">
                                        <!-- Datos cargados dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="fas fa-clock me-1"></i>Actividad por Hora
                        </div>
                        <div class="card-body">
                            <div id="hourlyChart" style="height: 250px;">
                                <div class="d-flex justify-content-center align-items-center h-100">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filtro de fechas personalizado -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-filter me-1"></i>Filtro Personalizado
                </div>
                <div class="card-body">
                    <form id="customDateForm" class="row g-3">
                        <div class="col-md-4">
                            <label for="dateFrom" class="form-label">Fecha Desde</label>
                            <input type="date" class="form-control" id="dateFrom">
                        </div>
                        <div class="col-md-4">
                            <label for="dateTo" class="form-label">Fecha Hasta</label>
                            <input type="date" class="form-control" id="dateTo">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search me-1"></i>Aplicar Filtro
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- JavaScript -->
        <script>
            // Variables globales
            let currentPeriod = 7;
            let statisticsData = null;

            // Inicializar la página
            document.addEventListener('DOMContentLoaded', function() {
                // Configurar fechas por defecto
                const today = new Date();
                const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                document.getElementById('dateTo').value = today.toISOString().split('T')[0];
                document.getElementById('dateFrom').value = weekAgo.toISOString().split('T')[0];
                
                loadStatistics();
                
                // Event listeners para botones de periodo
                document.querySelectorAll('[data-period]').forEach(btn => {
                    btn.addEventListener('click', function() {
                        document.querySelectorAll('[data-period]').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        currentPeriod = parseInt(this.dataset.period);
                        loadStatistics();
                    });
                });
                
                // Event listener para formulario de fecha personalizada
                document.getElementById('customDateForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    loadStatistics(true);
                });
            });

            // Cargar estadísticas
            async function loadStatistics(useCustomDates = false) {
                try {
                    showLoading(true);
                    
                    const params = new URLSearchParams();
                    params.append('days', currentPeriod);
                    
                    const response = await fetch(`/api/admin/statistics/complete?${params}`);
                    
                    if (!response.ok) {
                        throw new Error('Error al cargar estadísticas');
                    }
                    
                    statisticsData = await response.json();
                    renderStatistics();
                    
                } catch (error) {
                    console.error('Error:', error);
                    showAlert('Cargando datos de ejemplo. API no disponible.', 'warning');
                    showExampleData();
                } finally {
                    showLoading(false);
                }
            }

            // Renderizar estadísticas
            function renderStatistics() {
                if (!statisticsData) return;
                
                // Actualizar métricas principales
                document.getElementById('totalGames').textContent = formatNumber(statisticsData.totalGames || 0);
                document.getElementById('completedGames').textContent = formatNumber(statisticsData.completedGames || 0);
                document.getElementById('averageTime').textContent = formatTime(statisticsData.averageTime || 0);
                document.getElementById('activeUsers').textContent = formatNumber(statisticsData.activeUsers || 0);
                
                // Renderizar gráficos y tablas
                renderDailyActivityChart(statisticsData.dailyActivity);
                renderGameStatusChart(statisticsData.gameStatus);
                renderTrackStats(statisticsData.trackStats);
                renderHourlyChart(statisticsData.hourlyActivity);
            }

            // Mostrar/ocultar loading
            function showLoading(show) {
                const spinners = document.querySelectorAll('.spinner-border');
                spinners.forEach(spinner => {
                    spinner.parentElement.style.display = show ? 'flex' : 'none';
                });
            }

            // Renderizar gráfico de actividad diaria
            function renderDailyActivityChart(data) {
                const container = document.getElementById('dailyActivityChart');
                if (!data || data.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-4 text-muted">
                            <i class="fas fa-chart-line fa-2x mb-2"></i>
                            <p>No hay datos de actividad diaria</p>
                        </div>
                    `;
                    return;
                }
                
                // Crear gráfico simple con barras CSS
                let chartHTML = '<div class="row g-1 px-3">';
                const maxGames = Math.max(...data.map(d => d.games));
                
                data.forEach(day => {
                    const height = maxGames > 0 ? (day.games / maxGames) * 200 : 0;
                    const date = new Date(day.date);
                    chartHTML += `
                        <div class="col text-center">
                            <div class="d-flex flex-column align-items-center" style="height: 250px;">
                                <small class="mb-1">${day.games}</small>
                                <div class="bg-primary rounded-top" style="width: 20px; height: ${height}px; margin-top: auto;"></div>
                                <small class="mt-1 text-muted">${date.getDate()}/${date.getMonth() + 1}</small>
                            </div>
                        </div>
                    `;
                });
                chartHTML += '</div>';
                container.innerHTML = chartHTML;
            }

            // Renderizar gráfico de estado de partidas
            function renderGameStatusChart(data) {
                const container = document.getElementById('gameStatusChart');
                if (!data) {
                    container.innerHTML = `
                        <div class="text-center py-4 text-muted">
                            <i class="fas fa-chart-pie fa-2x mb-2"></i>
                            <p>No hay datos de estado</p>
                        </div>
                    `;
                    return;
                }
                
                const total = data.completed + data.inProgress;
                const completedPercent = total > 0 ? Math.round((data.completed / total) * 100) : 0;
                const inProgressPercent = 100 - completedPercent;
                
                container.innerHTML = `
                    <div class="px-3 py-2">
                        <div class="mb-3 text-center">
                            <div class="progress mb-2" style="height: 20px;">
                                <div class="progress-bar bg-success" style="width: ${completedPercent}%">${completedPercent}%</div>
                                <div class="progress-bar bg-warning" style="width: ${inProgressPercent}%">${inProgressPercent}%</div>
                            </div>
                        </div>
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="text-success">
                                    <i class="fas fa-check-circle"></i>
                                    <br><small>Completadas</small>
                                    <br><strong>${formatNumber(data.completed)}</strong>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-warning">
                                    <i class="fas fa-clock"></i>
                                    <br><small>En Progreso</small>
                                    <br><strong>${formatNumber(data.inProgress)}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Renderizar estadísticas por pista
            function renderTrackStats(data) {
                document.getElementById('loadingTracks').style.display = 'none';
                document.getElementById('trackStatsTable').style.display = 'block';
                
                const tbody = document.getElementById('trackStatsBody');
                if (!data || data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center py-3 text-muted">
                                No hay datos de pistas disponibles
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = data.map(track => {
                    const successRate = track.successRate || 0;
                    const badgeClass = successRate >= 80 ? 'bg-success' : successRate >= 60 ? 'bg-warning text-dark' : 'bg-danger';
                    const avgTime = track.averageTime ? Math.round(track.averageTime) : 0;
                    
                    return `
                        <tr>
                            <td><i class="fas fa-map text-primary me-1"></i>${track.trackName}</td>
                            <td>${formatNumber(track.totalGames)}</td>
                            <td><span class="badge ${badgeClass}">${successRate.toFixed(1)}%</span></td>
                            <td>${formatTime(avgTime)}</td>
                        </tr>
                    `;
                }).join('');
            }

            // Renderizar gráfico de actividad por hora
            function renderHourlyChart(data) {
                const container = document.getElementById('hourlyChart');
                if (!data || data.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-4 text-muted">
                            <i class="fas fa-clock fa-2x mb-2"></i>
                            <p>No hay datos de actividad por hora</p>
                        </div>
                    `;
                    return;
                }
                
                // Crear array de 24 horas
                const hourlyData = Array.from({length: 24}, (_, i) => {
                    const hourData = data.find(h => h.hour === i);
                    return {hour: i, games: hourData ? hourData.games : 0};
                });
                
                const maxGames = Math.max(...hourlyData.map(h => h.games));
                
                // Usar flexbox con ancho fijo para evitar desbordamiento
                let chartHTML = '<div class="d-flex justify-content-between align-items-end px-2" style="height: 200px; overflow-x: auto;">';
                hourlyData.forEach(hour => {
                    const height = maxGames > 0 ? Math.max((hour.games / maxGames) * 120, 2) : 2;
                    chartHTML += `
                        <div class="d-flex flex-column align-items-center mx-1" style="min-width: 20px;">
                            <small style="font-size: 9px; color: #666; margin-bottom: 2px;">${hour.games > 0 ? hour.games : ''}</small>
                            <div class="bg-info rounded-top" style="width: 8px; height: ${height}px;" title="${hour.hour}:00 - ${hour.games} partidas"></div>
                            <small class="mt-1" style="font-size: 8px; color: #999; writing-mode: sideways-lr;">${hour.hour}</small>
                        </div>
                    `;
                });
                chartHTML += '</div>';
                
                // Agregar leyenda
                chartHTML += `
                    <div class="text-center mt-2">
                        <small class="text-muted">Horas del día (0-23)</small>
                    </div>
                `;
                
                container.innerHTML = chartHTML;
            }

            // Mostrar datos de ejemplo
            function showExampleData() {
                document.getElementById('totalGames').textContent = '1,247';
                document.getElementById('completedGames').textContent = '892';
                document.getElementById('averageTime').textContent = '2m 15s';
                document.getElementById('activeUsers').textContent = '156';
                
                // Gráfico de actividad diaria (ejemplo)
                document.getElementById('dailyActivityChart').innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-chart-line fa-3x text-primary mb-3"></i>
                        <h5>Gráfico de Actividad Diaria</h5>
                        <p class="text-muted">Datos de ejemplo - Conecte con la API para datos reales</p>
                    </div>
                `;
                
                // Estado de partidas (ejemplo)
                renderGameStatusChart({completed: 892, inProgress: 355});
                
                // Estadísticas por pista (ejemplo)
                const exampleTracks = [
                    {trackName: 'Camino Recto', totalGames: 523, successRate: 93.5, averageTime: 35},
                    {trackName: 'Camino en L', totalGames: 456, successRate: 87.3, averageTime: 42},
                    {trackName: 'Laberinto Básico', totalGames: 268, successRate: 69.0, averageTime: 78}
                ];
                renderTrackStats(exampleTracks);
                
                // Actividad por hora (ejemplo)
                document.getElementById('hourlyChart').innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-clock fa-3x text-info mb-3"></i>
                        <h5>Actividad por Hora</h5>
                        <p class="text-muted">Datos de ejemplo - Conecte con la API para datos reales</p>
                    </div>
                `;
            }

            // Actualizar estadísticas
            function refreshStatistics() {
                loadStatistics();
            }

            // Exportar estadísticas
            async function exportStatistics() {
                try {
                    const params = new URLSearchParams({
                        days: currentPeriod,
                        format: 'csv'
                    });
                    
                    const response = await fetch(`/api/admin/statistics/export?${params}`);
                    
                    if (!response.ok) {
                        throw new Error('Error al exportar estadísticas');
                    }
                    
                    const data = await response.json();
                    showAlert(data.message || 'Exportación iniciada', 'success');
                    
                } catch (error) {
                    showAlert('Error al exportar estadísticas: ' + error.message, 'danger');
                }
            }

            // Utilities
            function formatNumber(num) {
                return new Intl.NumberFormat('es-ES').format(num);
            }

            function formatTime(seconds) {
                if (!seconds || seconds === 0) return '--';
                if (seconds < 60) return `${seconds}s`;
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return secs > 0 ? `${mins}m ${secs}s` : `${mins}m`;
            }

            function showAlert(message, type = 'info') {
                let alertContainer = document.getElementById('alertContainer');
                if (!alertContainer) {
                    alertContainer = document.createElement('div');
                    alertContainer.id = 'alertContainer';
                    alertContainer.className = 'position-fixed top-0 end-0 p-3';
                    alertContainer.style.zIndex = '9999';
                    document.body.appendChild(alertContainer);
                }
                
                const alert = document.createElement('div');
                alert.className = `alert alert-${type} alert-dismissible fade show`;
                alert.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                alertContainer.appendChild(alert);
                
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.parentNode.removeChild(alert);
                    }
                }, 5000);
            }
        </script>
    </main>
</body>
</html>